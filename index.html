<!DOCTYPE html>
<html>
<head>
    <title>WebRTC Video Call</title>
    <style>
        video {
            width: 45%;
            margin: 10px;
            border: 2px solid #ccc;
        }
    </style>
</head>
<body>
    <h2>WebRTC Django Video Call</h2>
    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>

    <script>
        const localVideo = document.getElementById("localVideo");
        const remoteVideo = document.getElementById("remoteVideo");

        let localStream;
        let peerConnection;

        const config = {
            iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
        };

        const socket = new WebSocket("ws://" + window.location.host + "/ws/signaling/");

        socket.onmessage = async (event) => {
            const data = JSON.parse(event.data);

            if (!peerConnection) await createPeerConnection();

            if (data.type === "offer") {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(data));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                socket.send(JSON.stringify(answer));
            }

            if (data.type === "answer") {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(data));
            }

            if (data.type === "ice-candidate") {
                try {
                    await peerConnection.addIceCandidate(data.candidate);
                } catch (e) {
                    console.error("Error adding received ice candidate", e);
                }
            }
        };

        async function createPeerConnection() {
            peerConnection = new RTCPeerConnection(config);

            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.send(JSON.stringify({
                        type: "ice-candidate",
                        candidate: event.candidate
                    }));
                }
            };

            peerConnection.ontrack = (event) => {
                remoteVideo.srcObject = event.streams[0];
            };

            localStream.getTracks().forEach(track =>
                peerConnection.addTrack(track, localStream)
            );
        }

        async function init() {
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            localVideo.srcObject = localStream;

            await createPeerConnection();

            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            socket.send(JSON.stringify(offer));
        }

        init();
    </script>
</body>
</html>